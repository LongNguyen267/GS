<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Nhân Viên</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

    <link rel="stylesheet" href="~/css/employee.css" asp-append-version="true" />
</head>
<body>

    <div class="sidebar" id="sidebar" style="background: linear-gradient(180deg, #1cc88a 10%, #13855c 100%);">
        <div class="sidebar-brand">
            <i class="fas fa-user-tie me-2"></i> NHÂN VIÊN
        </div>
        <div class="sidebar-menu">
            <a asp-action="Index" asp-controller="Employee" class="@(ViewContext.RouteData.Values["Controller"]?.ToString() == "Employee" ? "active" : "")">
                <i class="fas fa-home me-2"></i> Trang chủ
            </a>

            <hr style="border-color:rgba(255,255,255,0.2); margin: 15px 0;">

            <div style="color:rgba(255,255,255,0.6); font-size: 0.75rem; font-weight:bold; margin: 0 20px 10px; text-transform:uppercase;">Công việc</div>

            <a asp-action="Index" asp-controller="EmployeeNhapHang" class="@(ViewContext.RouteData.Values["Controller"]?.ToString() == "EmployeeNhapHang" ? "active" : "")">
                <i class="fas fa-dolly me-2"></i> Nhập hàng
            </a>
            <a asp-action="Index" asp-controller="AdminDonHang" class="@(ViewContext.RouteData.Values["Controller"]?.ToString() == "AdminDonHang" ? "active" : "")">
                <i class="fas fa-clipboard-list me-2"></i> Đơn hàng
            </a>
        </div>
    </div>

    <header class="admin-header" id="header">
        <button class="toggle-btn" onclick="toggleSidebar()" style="color: #1cc88a; border:none; background:none; font-size:1.5rem;">
            <i class="fas fa-bars"></i>
        </button>

        <div class="user-info d-flex align-items-center">
            <span class="user-name me-2 d-none d-sm-inline">@(User.Identity?.Name ?? "Nhân viên")</span>
            <div class="user-avatar" style="background-color: #1cc88a; width:35px; height:35px; border-radius:50%; display:flex; align-items:center; justify-content:center; color:white; font-weight:bold;">
                @((User.Identity?.Name?.Substring(0, 1) ?? "N").ToUpper())
            </div>
            <div style="width: 1px; height: 20px; background: #e3e6f0; margin: 0 15px;"></div>
            <a asp-controller="Account" asp-action="Logout" class="text-danger" title="Đăng xuất" style="font-size:1.2rem;">
                <i class="fas fa-sign-out-alt"></i>
            </a>
        </div>
    </header>

    <div class="main-wrapper" id="mainContent" style="margin-top: 80px;">
        @RenderBody()
    </div>

    <button class="emp-chat-toggle" onclick="toggleEmpChat()">
        <i class="fas fa-comments"></i>
    </button>

    <div class="emp-chat-box" id="empChatBox">
        <div class="ec-header">
            <span><i class="fas fa-headset me-2"></i> Hỗ trợ (Nhân viên)</span>
            <span style="cursor:pointer" onclick="toggleEmpChat()"><i class="fas fa-times"></i></span>
        </div>
        <div class="ec-body" id="empChatList">
            <div class="text-center text-muted small mt-5">
                <i class="fas fa-wifi mb-2"></i><br>Sẵn sàng nhận tin nhắn.
            </div>
        </div>
        <div class="ec-footer">
            <input type="text" class="ec-input" id="empMsgInput" placeholder="Nhập câu trả lời..." onkeypress="handleEmpEnter(event)">
            <button class="ec-btn-send" onclick="sendEmpMsg()"><i class="fas fa-paper-plane"></i></button>
        </div>
        <input type="hidden" id="currentEmpName" value="@(User.Identity?.Name ?? "Staff")" />
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        // Toggle Sidebar
        function toggleSidebar() {
            document.getElementById("sidebar").classList.toggle("hidden");
            document.getElementById("header").classList.toggle("full-width");
            document.getElementById("mainContent").classList.toggle("full-width");
        }

        // SignalR Chat Logic
        var connection = new signalR.HubConnectionBuilder().withUrl("/chatHub").build();

        connection.on("ReceiveMessage", function (user, message) {
            var chatList = document.getElementById("empChatList");
            var currentUser = document.getElementById("currentEmpName").value;

            // Xóa thông báo chờ
            if(chatList.querySelector('.text-center')) chatList.innerHTML = "";

            var msgDiv = document.createElement("div");
            if (user === currentUser) {
                msgDiv.className = "ec-msg ec-msg-out"; // Tin mình
                msgDiv.textContent = message;
            } else {
                var container = document.createElement("div");
                container.innerHTML = `<div class='ec-sender-name'>${user}</div>`;
                msgDiv.className = "ec-msg ec-msg-in"; // Tin khách
                msgDiv.textContent = message;
                container.appendChild(msgDiv);
                chatList.appendChild(container);
                return;
            }
            chatList.appendChild(msgDiv);
            chatList.scrollTop = chatList.scrollHeight;
        });

        connection.start().catch(err => console.error(err));

        function sendEmpMsg() {
            var user = document.getElementById("currentEmpName").value;
            var input = document.getElementById("empMsgInput");
            if (input.value.trim() !== "") {
                connection.invoke("SendMessage", user, input.value).catch(err => console.error(err));
                input.value = "";
            }
        }
        function toggleEmpChat() {
            var box = document.getElementById("empChatBox");
            box.style.display = (box.style.display === "flex") ? "none" : "flex";
        }
        function handleEmpEnter(e) { if (e.key === 'Enter') sendEmpMsg(); }
    </script>

    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>