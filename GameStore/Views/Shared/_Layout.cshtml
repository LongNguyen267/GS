<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>@(ViewData["Title"] ?? "Trang chủ") - Chill Game Store</title>

    <meta name="description" content="@(ViewData["MetaDescription"] ?? "Chill Game Store - Chuyên cung cấp máy game, đĩa game và phụ kiện chính hãng giá tốt nhất.")">
    <meta name="keywords" content="@(ViewData["MetaKeywords"] ?? "game store, ps5, nintendo switch, đĩa game, tay cầm xbox")">

    <meta property="og:title" content="@(ViewData["Title"] ?? "Chill Game Store")" />
    <meta property="og:description" content="@(ViewData["MetaDescription"] ?? "Cửa hàng game uy tín số 1 Việt Nam")" />
    <meta property="og:image" content="@(ViewData["OgImage"] ?? "https://yourdomain.com/image/NIIE.png")" />
    <meta property="og:type" content="website" />

    <link rel="stylesheet" href="~/css/style.css" asp-append-version="true" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <link rel="stylesheet" href="~/css/Cart.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/product-detail.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/subcategory-filter.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/confirmation-page.css" asp-append-version="true" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" />

    @await RenderSectionAsync("Styles", required: false)
</head>
<body>
    <header class="main-header">
        <div class="logo">
            <a asp-controller="Home" asp-action="Index">
                <img src="~/image/NIIE.png" alt="NIIE">
            </a>
        </div>
        <nav class="main-nav">
            <a asp-controller="Home" asp-action="Index">Trang chủ</a>
            <a asp-controller="Products" asp-action="Index" asp-route-type="MayGame">Sản phẩm</a>
            <a asp-controller="Products" asp-action="Index" asp-route-type="DiaGame">Đĩa Game</a>
            <a asp-controller="Products" asp-action="Index" asp-route-type="PhuKien">Phụ kiện</a>
        </nav>
        <div class="user-actions">
            <div class="search-container">
                <input type="text" id="searchInput" placeholder="Tìm kiếm sản phẩm..." class="search-input">
                <button id="searchButton" class="search-btn"><i class="fas fa-search"></i></button>
                <div id="searchResults" class="search-results-dropdown">
                </div>
            </div>
            <a asp-controller="Cart" asp-action="Index">
                <i class="fas fa-shopping-bag"></i>
            </a>
            @if (User.Identity != null && User.Identity.IsAuthenticated)
            {
                <a class="nav-link text-white" href="#">Xin chào, @User.Identity.Name</a>

                <a class="nav-link text-white" asp-controller="KhachHang" asp-action="OrderHistory" title="Lịch sử đơn hàng">
                    <i class="fas fa-history"></i>
                </a>

                <a class="nav-link text-white" asp-controller="Account" asp-action="Logout" title="Đăng xuất">
                    <i class="fas fa-sign-out-alt"></i>
                </a>
            }
            else
            {
                <a class="nav-link text-white" asp-controller="Account" asp-action="Login" title="Đăng nhập">
                    <i class="far fa-user"></i>
                </a>
            }
        </div>
    </header>

    <div class="container">
        <main role="main" class="pb-3">
            @RenderBody()
        </main>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <script src="~/js/java.js"></script>
    <script src="~/js/cart.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const searchInput = document.getElementById('searchInput');
            const searchResults = document.getElementById('searchResults');
            let timeout = null;

            searchInput.addEventListener('input', function () {
                clearTimeout(timeout);
                const query = this.value;
                if (query.length < 2) {
                    searchResults.style.display = 'none';
                    return;
                }

                timeout = setTimeout(() => {
                    fetch(`/Products/Search?query=${query}`)
                        .then(response => response.json())
                        .then(products => {
                            if (products.length > 0) {
                                searchResults.innerHTML = products.map(product => `
                                    <a href="/Products/Details/${product.id}" class="search-result-item">
                                        <img src="${product.imageUrl}" alt="${product.name}" />
                                        <div>
                                            <h5>${product.name}</h5>
                                            <p>${product.price.toLocaleString('vi-VN')} đ</p>
                                        </div>
                                    </a>
                                `).join('');
                                searchResults.style.display = 'block';
                            } else {
                                searchResults.innerHTML = '<div class="no-results">Không tìm thấy sản phẩm.</div>';
                                searchResults.style.display = 'block';
                            }
                        });
                }, 300);
            });
        });
    </script>

    <button class="lc-toggle-btn" onclick="toggleChat()">
        <i class="fas fa-comment-dots"></i>
    </button>

    <div class="lc-chat-box" id="liveChatBox">
        <div class="lc-header">
            <span><i class="fas fa-headset"></i> Hỗ trợ trực tuyến</span>
            <span class="lc-close-btn" onclick="toggleChat()"><i class="fas fa-times"></i></span>
        </div>

        <div class="lc-body" id="chatList">
            <div class="lc-msg lc-msg-in">
                Xin chào! @(User.Identity != null && User.Identity.IsAuthenticated ? User.Identity.Name : "Bạn") cần hỗ trợ gì không?
            </div>
        </div>

        <div class="lc-footer">
            <input type="hidden" id="chatUser" value="@(User.Identity != null && User.Identity.IsAuthenticated ? User.Identity.Name : "Khách")" />
            <input type="text" class="lc-input" id="chatMessage" placeholder="Nhập tin nhắn..." onkeypress="handleChatEnter(event)">
            <button class="lc-send-btn" onclick="sendChatMessage()"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.js"></script>

    <script>
        // 1. Kết nối
        var connection = new signalR.HubConnectionBuilder().withUrl("/chatHub").build();

        // 2. Nhận tin nhắn
        connection.on("ReceiveMessage", function (user, message) {
            var chatList = document.getElementById("chatList");
            var currentUser = document.getElementById("chatUser").value;

            var msgDiv = document.createElement("div");
            msgDiv.classList.add("lc-msg"); // Class chung

            if (user === currentUser) {
                msgDiv.classList.add("lc-msg-out"); // Tin của mình
                msgDiv.textContent = message;
            } else {
                msgDiv.classList.add("lc-msg-in"); // Tin người khác
                msgDiv.innerHTML = `<span class="lc-sender-name">${user}</span>${message}`;
            }

            chatList.appendChild(msgDiv);
            chatList.scrollTop = chatList.scrollHeight;
        });

        // 3. Bắt đầu kết nối
        connection.start().catch(err => console.error(err.toString()));

        // 4. Gửi tin nhắn
        function sendChatMessage() {
            var user = document.getElementById("chatUser").value;
            var messageInput = document.getElementById("chatMessage");
            var msg = messageInput.value;

            if (msg.trim() === "") return;

            connection.invoke("SendMessage", user, msg).catch(err => console.error(err.toString()));
            messageInput.value = "";
        }

        // 5. Các hàm hỗ trợ
        function toggleChat() {
            var box = document.getElementById("liveChatBox");
            if (box.style.display === "flex") box.style.display = "none";
            else box.style.display = "flex";
        }

        function handleChatEnter(e) {
            if (e.key === 'Enter') sendChatMessage();
        }
    </script>
    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>